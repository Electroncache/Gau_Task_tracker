<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务提交记录工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            max-width: 1300px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        .input-row {
            background-color: #e6f7ff;
        }
        .input-row input, .input-row select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            margin-right: 5px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .time-btn {
            background-color: #2196F3;
            margin-left: 5px;
        }
        .time-btn:hover {
            background-color: #0b7dda;
        }
        .delete-btn {
            background-color: #f44336;
            padding: 5px 10px;
            font-size: 12px;
        }
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        .edit-btn {
            background-color: #ff9800;
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
        }
        .edit-btn:hover {
            background-color: #e68a00;
        }
        .save-btn {
            background-color: #4CAF50;
            padding: 5px 10px;
            font-size: 12px;
            margin-right: 5px;
        }
        .save-btn:hover {
            background-color: #45a049;
        }
        .cancel-btn {
            background-color: #9e9e9e;
            padding: 5px 10px;
            font-size: 12px;
        }
        .cancel-btn:hover {
            background-color: #757575;
        }
        .status-running {
            color: #2196F3;
            font-weight: bold;
        }
        .status-finish {
            color: #4CAF50;
            font-weight: bold;
        }
        .status-error {
            color: #f44336;
            font-weight: bold;
        }
        .status-killed {
            color: #9e9e9e;
            font-weight: bold;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .controls-group {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .export-btn {
            background-color: #ff9800;
        }
        .export-btn:hover {
            background-color: #e68a00;
        }
        .import-btn {
            background-color: #2196F3;
        }
        .import-btn:hover {
            background-color: #0b7dda;
        }
        .clear-btn {
            background-color: #9e9e9e;
        }
        .clear-btn:hover {
            background-color: #757575;
        }
        .clear-finish-btn {
            background-color: #4CAF50;
        }
        .clear-finish-btn:hover {
            background-color: #45a049;
        }
        .clear-error-btn {
            background-color: #f44336;
        }
        .clear-error-btn:hover {
            background-color: #d32f2f;
        }
        .clear-killed-btn {
            background-color: #9e9e9e;
        }
        .clear-killed-btn:hover {
            background-color: #757575;
        }
        .editing {
            background-color: #fffde7;
        }
        .action-cell {
            white-space: nowrap;
        }
        .file-input {
            display: none;
        }
        .custom-input {
            margin-top: 5px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>任务提交记录</h1>

        <div class="controls">
            <div class="controls-group">
                <button id="export-btn" class="btn export-btn">导出数据</button>
                <button id="import-btn" class="btn import-btn">导入数据</button>
                <input type="file" id="import-file" class="file-input" accept=".csv">
            </div>
            <div class="controls-group">
                <button id="clear-all-btn" class="btn clear-btn">清空所有记录</button>
                <button id="clear-finish-btn" class="btn clear-finish-btn">清空完成任务</button>
                <button id="clear-error-btn" class="btn clear-error-btn">清空错误任务</button>
                <button id="clear-killed-btn" class="btn clear-killed-btn">清空中断任务</button>
            </div>
        </div>

        <table id="task-table">
            <thead>
                <tr>
                    <th width="12%">提交时间</th>
                    <th width="15%">任务文件名</th>
                    <th width="12%">程序</th>
                    <th width="12%">节点信息</th>
                    <th width="8%">状态</th>
                    <th width="12%">完成/错误时间</th>
                    <th width="12%">备注1</th>
                    <th width="12%">备注2</th>
                    <th width="10%">操作</th>
                </tr>
            </thead>
            <tbody>
                <tr class="input-row">
                    <td>
                        <div style="display: flex; align-items: center;">
                            <input type="text" id="submit-time" placeholder="提交时间">
                            <button id="time-now-btn" class="btn time-btn">现在</button>
                        </div>
                    </td>
                    <td><input type="text" id="task-filename" placeholder="任务文件名"></td>
                    <td>
                        <select id="program-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">-- 选择程序 --</option>
                            <option value="g09">g09</option>
                            <option value="g16">g16</option>
                            <option value="custom">自定义</option>
                        </select>
                        <input type="text" id="program-name" class="custom-input" placeholder="自定义程序" style="display: none;">
                    </td>
                    <td><input type="text" id="node-info" placeholder="节点信息"></td>
                    <td>
                        <select id="status">
                            <option value="RUNNING">RUNNING</option>
                            <option value="FINISH">FINISH</option>
                            <option value="ERROR">ERROR</option>
                            <option value="KILLED">KILLED</option>
                        </select>
                    </td>
                    <td><input type="text" id="complete-time" placeholder="完成时间" readonly></td>
                    <td><input type="text" id="notes1" placeholder="备注1"></td>
                    <td><input type="text" id="notes2" placeholder="备注2"></td>
                    <td><button id="add-task-btn" class="btn">添加</button></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取元素
            const submitTimeInput = document.getElementById('submit-time');
            const timeNowBtn = document.getElementById('time-now-btn');
            const taskFilenameInput = document.getElementById('task-filename');
            const programSelect = document.getElementById('program-select');
            const programNameInput = document.getElementById('program-name');
            const nodeInfoInput = document.getElementById('node-info');
            const statusSelect = document.getElementById('status');
            const completeTimeInput = document.getElementById('complete-time');
            const notes1Input = document.getElementById('notes1');
            const notes2Input = document.getElementById('notes2');
            const addTaskBtn = document.getElementById('add-task-btn');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFile = document.getElementById('import-file');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const clearFinishBtn = document.getElementById('clear-finish-btn');
            const clearErrorBtn = document.getElementById('clear-error-btn');
            const clearKilledBtn = document.getElementById('clear-killed-btn');
            const taskTable = document.getElementById('task-table');
            
            // 存储正在编辑的行的原始数据
            let editingRowOriginalData = null;
            
            // 从本地存储加载任务
            loadTasks();

            // 程序选择事件处理
            programSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    programNameInput.style.display = 'block';
                    programNameInput.focus();
                } else {
                    programNameInput.style.display = 'none';
                    programNameInput.value = '';
                }
            });

            // 点击"现在"按钮插入当前时间
            timeNowBtn.addEventListener('click', function() {
                submitTimeInput.value = getCurrentTime();
            });

            // 状态改变时自动填入完成时间
            statusSelect.addEventListener('change', function() {
                if (statusSelect.value === 'FINISH' || statusSelect.value === 'ERROR' || statusSelect.value === 'KILLED') {
                    completeTimeInput.value = getCurrentTime();
                } else {
                    completeTimeInput.value = '';
                }
            });

            // 添加任务
            addTaskBtn.addEventListener('click', function() {
                if (!submitTimeInput.value || !taskFilenameInput.value || !nodeInfoInput.value) {
                    alert('请填写必填字段：提交时间、任务文件名和节点信息');
                    return;
                }

                // 获取程序名称
                let programValue = '';
                if (programSelect.value === 'custom') {
                    if (!programNameInput.value.trim()) {
                        alert('请填写自定义程序名称');
                        return;
                    }
                    programValue = programNameInput.value;
                } else if (programSelect.value) {
                    programValue = programSelect.value;
                } else {
                    alert('请选择程序');
                    return;
                }
                
                const newRow = document.createElement('tr');
                newRow.setAttribute('data-submit-time', submitTimeInput.value);
                
                // 设置状态的CSS类
                let statusClass = '';
                if (statusSelect.value === 'RUNNING') statusClass = 'status-running';
                else if (statusSelect.value === 'FINISH') statusClass = 'status-finish';
                else if (statusSelect.value === 'ERROR') statusClass = 'status-error';
                else if (statusSelect.value === 'KILLED') statusClass = 'status-killed';
                
                newRow.innerHTML = `
                    <td>${submitTimeInput.value}</td>
                    <td>${taskFilenameInput.value}</td>
                    <td>${programValue}</td>
                    <td>${nodeInfoInput.value}</td>
                    <td class="${statusClass}">${statusSelect.value}</td>
                    <td>${completeTimeInput.value}</td>
                    <td>${notes1Input.value}</td>
                    <td>${notes2Input.value}</td>
                    <td class="action-cell">
                        <button class="btn edit-btn">编辑</button>
                        <button class="btn delete-btn">删除</button>
                    </td>
                `;

                // 在输入行之前插入新行
                const tbody = taskTable.querySelector('tbody');
                const inputRow = taskTable.querySelector('.input-row');
                tbody.insertBefore(newRow, inputRow);

                // 保存任务到本地存储
                saveTasks();

                // 清空输入字段
                submitTimeInput.value = '';
                taskFilenameInput.value = '';
                programSelect.value = '';
                programNameInput.style.display = 'none';
                programNameInput.value = '';
                nodeInfoInput.value = '';
                statusSelect.value = 'RUNNING';
                completeTimeInput.value = '';
                notes1Input.value = '';
                notes2Input.value = '';

                // 为新添加的按钮添加事件监听器
                setupRowButtonListeners(newRow);
            });

            // 导出数据
            exportBtn.addEventListener('click', function() {
                const rows = Array.from(taskTable.querySelectorAll('tbody tr:not(.input-row)'));
                if (rows.length === 0) {
                    alert('没有数据可导出');
                    return;
                }

                // 使用BOM确保Excel正确识别UTF-8编码
                let csvContent = '\ufeff提交时间,任务文件名,程序,节点信息,状态,完成/错误时间,备注1,备注2\r\n';
                
                rows.forEach(row => {
                    const cells = Array.from(row.querySelectorAll('td:not(:last-child)'));
                    const rowData = cells.map(cell => {
                        // 处理CSV中的逗号和引号
                        let content = cell.textContent.trim();
                        if (content.includes(',') || content.includes('"') || content.includes('\n')) {
                            content = '"' + content.replace(/"/g, '""') + '"';
                        }
                        return content;
                    });
                    csvContent += rowData.join(',') + '\r\n';
                });

                // 创建下载链接
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', '任务记录_' + new Date().toISOString().slice(0, 10) + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // 导入数据
            importBtn.addEventListener('click', function() {
                importFile.click();
            });

            importFile.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        // 读取文件内容
                        let content = event.target.result;
                        
                        // 检测BOM并移除
                        if (content.charCodeAt(0) === 0xFEFF) {
                            content = content.slice(1);
                        }
                        
                        // 按行分割
                        const lines = content.split(/\r\n|\n/);
                        
                        // 跳过表头行
                        if (lines.length <= 1) {
                            alert('CSV文件无有效数据');
                            return;
                        }
                        
                        // 解析数据行
                        const tasks = [];
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue; // 跳过空行
                            
                            // 解析CSV行，处理引号包裹的字段
                            const fields = [];
                            let fieldStart = 0;
                            let inQuotes = false;
                            
                            for (let j = 0; j < lines[i].length; j++) {
                                if (lines[i][j] === '"') {
                                    inQuotes = !inQuotes;
                                } else if (lines[i][j] === ',' && !inQuotes) {
                                    let field = lines[i].substring(fieldStart, j);
                                    // 处理引号包裹的字段
                                    if (field.startsWith('"') && field.endsWith('"')) {
                                        field = field.substring(1, field.length - 1).replace(/""/g, '"');
                                    }
                                    fields.push(field);
                                    fieldStart = j + 1;
                                }
                            }
                            
                            // 处理最后一个字段
                            let lastField = lines[i].substring(fieldStart);
                            if (lastField.startsWith('"') && lastField.endsWith('"')) {
                                lastField = lastField.substring(1, lastField.length - 1).replace(/""/g, '"');
                            }
                            fields.push(lastField);
                            
                            // 确保有足够的字段
                            if (fields.length >= 6) {
                                // 兼容旧格式，将KILL转换为KILLED
                                let status = fields[4];
                                if (status === 'KILL') {
                                    status = 'KILLED';
                                }
                                
                                tasks.push({
                                    submitTime: fields[0],
                                    taskFilename: fields[1],
                                    programName: fields[2],
                                    nodeInfo: fields[3],
                                    status: status,
                                    completeTime: fields[5],
                                    notes1: fields[6] || '',
                                    notes2: fields[7] || ''
                                });
                            }
                        }
                        
                        if (tasks.length === 0) {
                            alert('未找到有效数据');
                            return;
                        }
                        
                        const confirmed = confirm(`将导入 ${tasks.length} 条任务记录，是否继续？`);
                        if (!confirmed) return;
                        
                        // 添加导入的任务
                        const tbody = taskTable.querySelector('tbody');
                        const inputRow = taskTable.querySelector('.input-row');
                        
                        tasks.forEach(task => {
                            const newRow = document.createElement('tr');
                            newRow.setAttribute('data-submit-time', task.submitTime);
                            
                            // 设置状态的CSS类
                            let statusClass = '';
                            if (task.status === 'RUNNING') statusClass = 'status-running';
                            else if (task.status === 'FINISH') statusClass = 'status-finish';
                            else if (task.status === 'ERROR') statusClass = 'status-error';
                            else if (task.status === 'KILLED') statusClass = 'status-killed';
                            
                            newRow.innerHTML = `
                                <td>${task.submitTime}</td>
                                <td>${task.taskFilename}</td>
                                <td>${task.programName}</td>
                                <td>${task.nodeInfo}</td>
                                <td class="${statusClass}">${task.status}</td>
                                <td>${task.completeTime}</td>
                                <td>${task.notes1}</td>
                                <td>${task.notes2}</td>
                                <td class="action-cell">
                                    <button class="btn edit-btn">编辑</button>
                                    <button class="btn delete-btn">删除</button>
                                </td>
                            `;
                            
                            tbody.insertBefore(newRow, inputRow);
                            
                            // 为按钮添加事件监听器
                            setupRowButtonListeners(newRow);
                        });
                        
                        // 保存任务到本地存储
                        saveTasks();
                        
                        alert(`成功导入 ${tasks.length} 条任务记录`);
                    } catch (error) {
                        console.error(error);
                        alert('导入失败：' + error.message);
                    }
                    
                    // 清空文件输入，允许再次选择同一文件
                    importFile.value = '';
                };
                
                reader.onerror = function() {
                    alert('读取文件失败');
                };
                
                reader.readAsText(file);
            });

            // 清空所有记录
            clearAllBtn.addEventListener('click', function() {
                if (confirm('确定要删除所有记录吗？此操作无法撤销。')) {
                    const tbody = taskTable.querySelector('tbody');
                    const inputRow = taskTable.querySelector('.input-row');
                    
                    // 删除除了输入行之外的所有行
                    Array.from(tbody.querySelectorAll('tr:not(.input-row)')).forEach(row => {
                        row.remove();
                    });
                    
                    // 清除本地存储
                    localStorage.removeItem('taskData');
                }
            });

            // 清空完成任务
            clearFinishBtn.addEventListener('click', function() {
                if (confirm('确定要删除所有完成的任务记录吗？此操作无法撤销。')) {
                    const rows = Array.from(taskTable.querySelectorAll('tbody tr:not(.input-row)'));
                    let count = 0;
                    
                    rows.forEach(row => {
                        const statusCell = row.querySelector('td:nth-child(5)');
                        if (statusCell.textContent === 'FINISH') {
                            row.remove();
                            count++;
                        }
                    });
                    
                    if (count > 0) {
                        saveTasks();
                        alert(`已删除 ${count} 条完成任务记录`);
                    } else {
                        alert('没有找到完成的任务记录');
                    }
                }
            });

            // 清空错误任务
            clearErrorBtn.addEventListener('click', function() {
                if (confirm('确定要删除所有错误的任务记录吗？此操作无法撤销。')) {
                    const rows = Array.from(taskTable.querySelectorAll('tbody tr:not(.input-row)'));
                    let count = 0;
                    
                    rows.forEach(row => {
                        const statusCell = row.querySelector('td:nth-child(5)');
                        if (statusCell.textContent === 'ERROR') {
                            row.remove();
                            count++;
                        }
                    });
                    
                    if (count > 0) {
                        saveTasks();
                        alert(`已删除 ${count} 条错误任务记录`);
                    } else {
                        alert('没有找到错误的任务记录');
                    }
                }
            });

            // 清空KILLED任务
            clearKilledBtn.addEventListener('click', function() {
                if (confirm('确定要删除所有中断的任务记录吗？此操作无法撤销。')) {
                    const rows = Array.from(taskTable.querySelectorAll('tbody tr:not(.input-row)'));
                    let count = 0;
                    
                    rows.forEach(row => {
                        const statusCell = row.querySelector('td:nth-child(5)');
                        if (statusCell.textContent === 'KILLED') {
                            row.remove();
                            count++;
                        }
                    });
                    
                    if (count > 0) {
                        saveTasks();
                        alert(`已删除 ${count} 条中断任务记录`);
                    } else {
                        alert('没有找到中断的任务记录');
                    }
                }
            });

            // 获取当前时间的函数
            function getCurrentTime() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            }

            // 保存任务到本地存储
            function saveTasks() {
                const rows = Array.from(taskTable.querySelectorAll('tbody tr:not(.input-row)'));
                const taskData = rows.map(row => {
                    const cells = Array.from(row.querySelectorAll('td:not(:last-child)'));
                    return {
                        submitTime: cells[0].textContent,
                        taskFilename: cells[1].textContent,
                        programName: cells[2].textContent,
                        nodeInfo: cells[3].textContent,
                        status: cells[4].textContent,
                        completeTime: cells[5].textContent,
                        notes1: cells[6].textContent,
                        notes2: cells[7].textContent
                    };
                });
                
                localStorage.setItem('taskData', JSON.stringify(taskData));
            }

            // 从本地存储加载任务
            function loadTasks() {
                const taskData = JSON.parse(localStorage.getItem('taskData') || '[]');
                const tbody = taskTable.querySelector('tbody');
                const inputRow = taskTable.querySelector('.input-row');
                
                taskData.forEach(task => {
                    const newRow = document.createElement('tr');
                    newRow.setAttribute('data-submit-time', task.submitTime);
                    
                    // 兼容性处理：将KILL转换为KILLED
                    if (task.status === 'KILL') {
                        task.status = 'KILLED';
                    }
                    
                    // 设置状态的CSS类
                    let statusClass = '';
                    if (task.status === 'RUNNING') statusClass = 'status-running';
                    else if (task.status === 'FINISH') statusClass = 'status-finish';
                    else if (task.status === 'ERROR') statusClass = 'status-error';
                    else if (task.status === 'KILLED') statusClass = 'status-killed';
                    
                    newRow.innerHTML = `
                        <td>${task.submitTime}</td>
                        <td>${task.taskFilename}</td>
                        <td>${task.programName || ''}</td>
                        <td>${task.nodeInfo}</td>
                        <td class="${statusClass}">${task.status}</td>
                        <td>${task.completeTime}</td>
                        <td>${task.notes1 || ''}</td>
                        <td>${task.notes2 || ''}</td>
                        <td class="action-cell">
                            <button class="btn edit-btn">编辑</button>
                            <button class="btn delete-btn">删除</button>
                        </td>
                    `;
                    
                    tbody.insertBefore(newRow, inputRow);
                    
                    // 为按钮添加事件监听器
                    setupRowButtonListeners(newRow);
                });
            }

            // 为行按钮设置事件监听器
            function setupRowButtonListeners(row) {
                // 删除按钮事件
                row.querySelector('.delete-btn').addEventListener('click', function() {
                    if (confirm('确定要删除这条记录吗？')) {
                        row.remove();
                        saveTasks();
                    }
                });
                
                // 编辑按钮事件
                row.querySelector('.edit-btn').addEventListener('click', function() {
                    // 如果已经有行在编辑中，取消编辑
                    const editingRow = document.querySelector('tr.editing');
                    if (editingRow && editingRow !== row) {
                        cancelEdit(editingRow);
                    }
                    
                    // 开始编辑当前行
                    startEdit(row);
                });
            }

            // 开始编辑行
            function startEdit(row) {
                // 标记行为编辑状态
                row.classList.add('editing');
                
                // 存储原始数据以便取消
                const cells = Array.from(row.querySelectorAll('td:not(:last-child)'));
                editingRowOriginalData = {
                    submitTime: cells[0].textContent,
                    taskFilename: cells[1].textContent,
                    programName: cells[2].textContent,
                    nodeInfo: cells[3].textContent,
                    status: cells[4].textContent,
                    completeTime: cells[5].textContent,
                    notes1: cells[6].textContent,
                    notes2: cells[7].textContent
                };
                
                // 获取当前值
                const submitTime = cells[0].textContent;
                const taskFilename = cells[1].textContent;
                const programName = cells[2].textContent;
                const nodeInfo = cells[3].textContent;
                const status = cells[4].textContent;
                const completeTime = cells[5].textContent;
                const notes1 = cells[6].textContent;
                const notes2 = cells[7].textContent;
                
                // 创建程序选择HTML
                let isCustomProgram = programName !== 'g09' && programName !== 'g16';
                let programSelectHtml = `
                    <select class="edit-program-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">-- 选择程序 --</option>
                        <option value="g09" ${programName === 'g09' ? 'selected' : ''}>g09</option>
                        <option value="g16" ${programName === 'g16' ? 'selected' : ''}>g16</option>
                        <option value="custom" ${isCustomProgram ? 'selected' : ''}>自定义</option>
                    </select>
                    <input type="text" value="${isCustomProgram ? programName : ''}" class="edit-program-name custom-input" ${isCustomProgram ? '' : 'style="display: none;"'}>
                `;
                
                // 替换为输入框
                cells[0].innerHTML = `<input type="text" value="${submitTime}" class="edit-submit-time">`;
                cells[1].innerHTML = `<input type="text" value="${taskFilename}" class="edit-task-filename">`;
                cells[2].innerHTML = programSelectHtml;
                cells[3].innerHTML = `<input type="text" value="${nodeInfo}" class="edit-node-info">`;
                cells[4].innerHTML = `
                    <select class="edit-status">
                        <option value="RUNNING" ${status === 'RUNNING' ? 'selected' : ''}>RUNNING</option>
                        <option value="FINISH" ${status === 'FINISH' ? 'selected' : ''}>FINISH</option>
                        <option value="ERROR" ${status === 'ERROR' ? 'selected' : ''}>ERROR</option>
                        <option value="KILLED" ${status === 'KILLED' ? 'selected' : ''}>KILLED</option>
                    </select>
                `;
                cells[5].innerHTML = `<input type="text" value="${completeTime}" class="edit-complete-time">`;
                cells[6].innerHTML = `<input type="text" value="${notes1}" class="edit-notes1">`;
                cells[7].innerHTML = `<input type="text" value="${notes2}" class="edit-notes2">`;
                
                // 更改操作按钮
                const actionCell = row.querySelector('td:last-child');
                actionCell.innerHTML = `
                    <button class="btn save-btn">保存</button>
                    <button class="btn cancel-btn">取消</button>
                `;

                // 为编辑状态中的程序选择添加事件
                const editProgramSelect = row.querySelector('.edit-program-select');
                const editProgramNameInput = row.querySelector('.edit-program-name');
                
                editProgramSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        editProgramNameInput.style.display = 'block';
                        editProgramNameInput.focus();
                    } else {
                        editProgramNameInput.style.display = 'none';
                        editProgramNameInput.value = '';
                    }
                });
                
                // 添加事件监听器
                const statusSelect = row.querySelector('.edit-status');
                const completeTimeInput = row.querySelector('.edit-complete-time');
                
                statusSelect.addEventListener('change', function() {
                    // 如果从RUNNING改为FINISH或ERROR或KILLED，且完成时间为空，则自动添加当前时间
                    const previousStatus = editingRowOriginalData.status;
                    if (previousStatus === 'RUNNING' && 
                        (this.value === 'FINISH' || this.value === 'ERROR' || this.value === 'KILLED') && 
                        !completeTimeInput.value.trim()) {
                        completeTimeInput.value = getCurrentTime();
                    }
                });
                
                // 保存按钮事件
                row.querySelector('.save-btn').addEventListener('click', function() {
                    saveEdit(row);
                });
                
                // 取消按钮事件
                row.querySelector('.cancel-btn').addEventListener('click', function() {
                    cancelEdit(row);
                });
            }

            // 保存编辑
            function saveEdit(row) {
                const submitTimeInput = row.querySelector('.edit-submit-time');
                const taskFilenameInput = row.querySelector('.edit-task-filename');
                const programSelect = row.querySelector('.edit-program-select');
                const programNameInput = row.querySelector('.edit-program-name');
                const nodeInfoInput = row.querySelector('.edit-node-info');
                const statusSelect = row.querySelector('.edit-status');
                const completeTimeInput = row.querySelector('.edit-complete-time');
                const notes1Input = row.querySelector('.edit-notes1');
                const notes2Input = row.querySelector('.edit-notes2');
                
                if (!submitTimeInput.value || !taskFilenameInput.value || !nodeInfoInput.value) {
                    alert('请填写必填字段：提交时间、任务文件名和节点信息');
                    return;
                }
                
                // 获取程序名称
                let programValue = '';
                if (programSelect.value === 'custom') {
                    if (!programNameInput.value.trim()) {
                        alert('请填写自定义程序名称');
                        return;
                    }
                    programValue = programNameInput.value;
                } else if (programSelect.value) {
                    programValue = programSelect.value;
                } else {
                    alert('请选择程序');
                    return;
                }
                
                // 设置状态的CSS类
                let statusClass = '';
                if (statusSelect.value === 'RUNNING') statusClass = 'status-running';
                else if (statusSelect.value === 'FINISH') statusClass = 'status-finish';
                else if (statusSelect.value === 'ERROR') statusClass = 'status-error';
                else if (statusSelect.value === 'KILLED') statusClass = 'status-killed';
                
                // 更新行内容
                const cells = Array.from(row.querySelectorAll('td:not(:last-child)'));
                cells[0].textContent = submitTimeInput.value;
                cells[1].textContent = taskFilenameInput.value;
                cells[2].textContent = programValue;
                cells[3].textContent = nodeInfoInput.value;
                cells[4].textContent = statusSelect.value;
                cells[4].className = statusClass;
                cells[5].textContent = completeTimeInput.value;
                cells[6].textContent = notes1Input.value;
                cells[7].textContent = notes2Input.value;
                
                // 恢复操作按钮
                const actionCell = row.querySelector('td:last-child');
                actionCell.innerHTML = `
                    <button class="btn edit-btn">编辑</button>
                    <button class="btn delete-btn">删除</button>
                `;
                
                // 重新添加事件监听器
                setupRowButtonListeners(row);
                
                // 移除编辑状态
                row.classList.remove('editing');
                
                // 清除原始数据
                editingRowOriginalData = null;
                
                // 保存到本地存储
                saveTasks();
            }

            // 取消编辑
            function cancelEdit(row) {
                // 从原始数据恢复
                const cells = Array.from(row.querySelectorAll('td:not(:last-child)'));
                
                // 设置状态的CSS类
                let statusClass = '';
                if (editingRowOriginalData.status === 'RUNNING') statusClass = 'status-running';
                else if (editingRowOriginalData.status === 'FINISH') statusClass = 'status-finish';
                else if (editingRowOriginalData.status === 'ERROR') statusClass = 'status-error';
                else if (editingRowOriginalData.status === 'KILLED') statusClass = 'status-killed';
                
                cells[0].textContent = editingRowOriginalData.submitTime;
                cells[1].textContent = editingRowOriginalData.taskFilename;
                cells[2].textContent = editingRowOriginalData.programName;
                cells[3].textContent = editingRowOriginalData.nodeInfo;
                cells[4].textContent = editingRowOriginalData.status;
                cells[4].className = statusClass;
                cells[5].textContent = editingRowOriginalData.completeTime;
                cells[6].textContent = editingRowOriginalData.notes1;
                cells[7].textContent = editingRowOriginalData.notes2;
                
                // 恢复操作按钮
                const actionCell = row.querySelector('td:last-child');
                actionCell.innerHTML = `
                    <button class="btn edit-btn">编辑</button>
                    <button class="btn delete-btn">删除</button>
                `;
                
                // 重新添加事件监听器
                setupRowButtonListeners(row);
                
                // 移除编辑状态
                row.classList.remove('editing');
                
                // 清除原始数据
                editingRowOriginalData = null;
            }

            // 为所有已存在的按钮添加事件监听器
            document.querySelectorAll('tr:not(.input-row)').forEach(row => {
                setupRowButtonListeners(row);
            });
        });
    </script>
</body>
</html>